# JVM—内存结构

![img](JVM概述.assets/20200608150440.png)

## 程序计数器

### 作用：

- 记住下一条jvm指令的执行地址

### 特点：

- 线程私有
- 不会出现内存溢出

## 虚拟机栈

- 栈：每个线程运行需要的内存空间

- 栈帧：每个方法运行时需要的内存，每个栈由多个栈帧组成，对应着每次方法调用时所占用的内存
- 每个栈只能有一个活动栈帧，对应着当前正在执行的那个方法

### 问题辨析

1. 垃圾回收是否涉及栈内存？

   不涉及

2. 栈内存分配越大越好么？

   栈内存越大反而会让线程数越少

   通过-Xss指令可以指定栈内存大小

   ```java
   -Xss1024k
   ```

3. 方法内的局部变量是否线程安全？

   - 每个线程都有自己私有的局部变量，静态方法也如此

   - 方法的参数未必是线程安全的

   - 方法的返回值也未必是线程安全的，其他线程可以拿到这个返回值并发的去执行

   <font color='red'>即对于引用对象，作用范围是方法内的局部变量才是线程安全的</font>

### 栈内存溢出Stack Overflow

- 栈帧过多：递归调用未设置结束条件

- 栈帧过大

### 线程运行诊断

1. cpu占用过多
   - 定位：
     - 用top定位哪个进程对cpu的占用过高
     - `ps H -eo pid,tid,%cpu | grep 进程id`(用ps命令进一步定位是哪个线程引起的cpu占用过高)
     - `jstack 进程id`,查看操作系统级别的线程id（nid）的时候需要自行将10进制线程id换算为十六进制，根据线程信息定位到具体的源码行号
2. 程序运行很长时间没有结果（线程死锁）

## 本地方法栈

- C++语言编写的方法在本地方法栈运行，Object的clone、hashCode、notify、notifyAll、wait，由native修饰符修饰的
- 线程私有

## 堆

- 通过new关键字，创建对象都会使用堆内存
- 线程共享的，堆中对象都需要考虑线程安全问题
- 有垃圾回收机制

### 堆内存溢出

- OutOfMemoryError:Java heap space

- 设置堆空间最大值的指令：(默认是4G)

  ```java
  -Xms8m
  ```

### 堆内存诊断

1. jps工具

   - 查看当前系统中有哪些java进程
   - 在terminal输入jps

2. jmap工具

   - 查看堆内存占用情况，只能查看某个时刻的

   - 对于1.8以上的版本，使用指令查看

     ```java
     jhsdb jmap --heap --pid 进程id
     ```

3. jconsole工具

   - 图形界面的，多功能的监测工具，可以连续监测

